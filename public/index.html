<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM Lead Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .status-badge {
      padding: 4px 8px;
      border-radius: 5px;
      font-size: 0.8rem;
      color: white;
      display: inline-block;
      min-width: 70px;
      text-align: center;
    }
    .status-NEW { background-color: #0d6efd; }
    .status-CONTACTED { background-color: #ffc107; color: black; }
    .status-VERIFIED { background-color: #198754; }
    .status-SUBMITTED { background-color: #fd7e14; }
    .status-CLOSED { background-color: #6c757d; }
    th.sortable:hover {
      cursor: pointer;
      text-decoration: underline;
    }
    td[contenteditable="true"] {
      background-color: #f8f9fa;
    }
  </style>
</head>
<body class="bg-light p-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0">CRM Lead Manager</h1>
      <button class="btn btn-outline-secondary" onclick="toggleDarkMode()">ðŸŒ“ Theme</button>
    </div>

    <form id="leadForm" class="card p-4 shadow-sm mb-4">
      <div class="row g-3">
        <div class="col-md-6">
          <input type="text" class="form-control" placeholder="First Name" name="firstName" required autocomplete="given-name" />
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" placeholder="Last Name" name="lastName" required autocomplete="family-name" />
        </div>
        <div class="col-md-6">
          <input type="email" class="form-control" placeholder="Email" name="email" required autocomplete="email" />
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" placeholder="Phone" name="phone" required autocomplete="tel" />
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" placeholder="Tort Type" name="tortType" required />
        </div>
      </div>
      <button type="submit" class="btn btn-primary mt-3">Create Lead</button>
      <div id="formMsg" class="mt-2"></div>
    </form>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="card-title mb-0">Lead List</h5>
          <select class="form-select w-auto" id="statusFilter" aria-label="Filter leads by status">
            <option value="all">All</option>
            <option value="NEW">NEW</option>
            <option value="CONTACTED">CONTACTED</option>
            <option value="VERIFIED">VERIFIED</option>
            <option value="SUBMITTED">SUBMITTED</option>
            <option value="CLOSED">CLOSED</option>
          </select>
        </div>
        <table class="table table-bordered table-striped" id="leadsTable" aria-label="List of leads">
          <thead class="table-light">
            <tr>
              <th class="sortable" scope="col" onclick="sortTable('firstName')" tabindex="0">First Name</th>
              <th class="sortable" scope="col" onclick="sortTable('lastName')" tabindex="0">Last Name</th>
              <th class="sortable" scope="col" onclick="sortTable('phone')" tabindex="0">Phone</th>
              <th class="sortable" scope="col" onclick="sortTable('email')" tabindex="0">Email</th>
              <th class="sortable" scope="col" onclick="sortTable('tortType')" tabindex="0">Tort</th>
              <th class="sortable" scope="col" onclick="sortTable('status')" tabindex="0">Status</th>
              <th class="sortable" scope="col" onclick="sortTable('createdAt')" tabindex="0">Date</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="leadsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const backendURL = 'https://crm-backend2-fhi5.onrender.com';

    let currentFilter = 'all';
    let sortKey = 'createdAt';
    let sortOrder = -1;

    async function fetchLeads() {
      try {
        const res = await fetch(`${backendURL}/leads`);
        if (!res.ok) throw new Error('Failed to load leads.');
        const leads = await res.json();

        const tbody = document.getElementById('leadsBody');
        tbody.innerHTML = '';

        const filtered = currentFilter === 'all'
          ? leads
          : leads.filter(lead => lead.status.toUpperCase() === currentFilter);

        filtered.sort((a, b) => {
          let valA = a[sortKey];
          let valB = b[sortKey];
          if (typeof valA === 'string') valA = valA.toLowerCase();
          if (typeof valB === 'string') valB = valB.toLowerCase();
          return sortOrder * (valA > valB ? 1 : valA < valB ? -1 : 0);
        });

        filtered.forEach(lead => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td contenteditable="true" onblur="inlineEdit('${lead._id}', 'firstName', this.innerText.trim())" aria-label="First Name">${lead.firstName}</td>
            <td contenteditable="true" onblur="inlineEdit('${lead._id}', 'lastName', this.innerText.trim())" aria-label="Last Name">${lead.lastName}</td>
            <td contenteditable="true" onblur="inlineEdit('${lead._id}', 'phone', this.innerText.trim())" aria-label="Phone">${lead.phone}</td>
            <td contenteditable="true" onblur="inlineEdit('${lead._id}', 'email', this.innerText.trim())" aria-label="Email">${lead.email}</td>
            <td contenteditable="true" onblur="inlineEdit('${lead._id}', 'tortType', this.innerText.trim())" aria-label="Tort Type">${lead.tortType}</td>
            <td contenteditable="true" onblur="inlineEdit('${lead._id}', 'status', this.innerText.trim().toUpperCase())" aria-label="Status">
              <span class="status-badge status-${lead.status}">${lead.status}</span>
            </td>
            <td>${new Date(lead.createdAt).toLocaleDateString()}</td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="deleteLead('${lead._id}')" aria-label="Delete Lead">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        alert(error.message);
      }
    }

    async function inlineEdit(id, field, value) {
      try {
        const res = await fetch(`${backendURL}/leads/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [field]: value })
        });
        if (!res.ok) throw new Error('Failed to update lead');
        fetchLeads();
      } catch (err) {
        alert(err.message);
      }
    }

    function sortTable(key) {
      if (sortKey === key) {
        sortOrder = -sortOrder;
      } else {
        sortKey = key;
        sortOrder = 1;
      }
      fetchLeads();
    }

    document.getElementById('leadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form));
      try {
        const res = await fetch(`${backendURL}/leads`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) {
          const errData = await res.json();
          throw new Error(errData.message || 'Failed to create lead');
        }
        form.reset();
        document.getElementById('formMsg').innerHTML = '<div class="alert alert-success">Lead created successfully!</div>';
        fetchLeads();
      } catch (err) {
        document.getElementById('formMsg').innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
      }
    });

    document.getElementById('statusFilter').addEventListener('change', (e) => {
      currentFilter = e.target.value;
      fetchLeads();
    });

    async function deleteLead(id) {
      if (!confirm('Delete this lead?')) return;
      try {
        const res = await fetch(`${backendURL}/leads/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to delete lead');
        fetchLeads();
      } catch (err) {
        alert(err.message);
      }
    }

    function toggleDarkMode() {
      document.body.classList.toggle('bg-dark');
      document.body.classList.toggle('text-light');
      document.querySelectorAll('.card').forEach(card => card.classList.toggle('bg-secondary'));
    }

    fetchLeads();
  </script>
</body>
</html>
