<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lead Manager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    body.dark {
      background-color: #1a1a1a;
      color: #eee;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
    }
    h1 {
      margin: 0;
    }
    form, table {
      width: 100%;
      max-width: 1000px;
      margin: 20px auto;
    }
    input, button {
      margin: 5px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
      user-select: none;
    }
    th {
      cursor: move;
      background-color: #eee;
    }
    .dark th {
      background-color: #333;
    }
    .actions button {
      margin: 0 4px;
    }
    #settingsIcon {
      cursor: pointer;
      font-size: 22px;
      user-select: none;
    }
    #settingsPanel {
      position: absolute;
      right: 20px;
      top: 60px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      display: none;
      z-index: 999;
      max-width: 300px;
    }
    .dark #settingsPanel {
      background: #333;
      color: #fff;
      border-color: #555;
    }
    .settings-group {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Lead Manager</h1>
    <div id="settingsIcon" title="Settings">⚙️</div>
  </header>

  <div id="settingsPanel" aria-label="Settings Panel">
    <div class="settings-group">
      <strong>Display</strong>
      <div>
        <label><input type="checkbox" class="column-toggle" value="firstName" checked> First Name</label><br>
        <label><input type="checkbox" class="column-toggle" value="lastName" checked> Last Name</label><br>
        <label><input type="checkbox" class="column-toggle" value="phone" checked> Phone</label><br>
        <label><input type="checkbox" class="column-toggle" value="email" checked> Email</label><br>
        <label><input type="checkbox" class="column-toggle" value="tortType" checked> Tort</label><br>
        <label><input type="checkbox" class="column-toggle" value="status" checked> Status</label><br>
        <label><input type="checkbox" class="column-toggle" value="createdAt" checked> Date</label>
      </div>
    </div>
    <div class="settings-group">
      <strong>Theme</strong><br>
      <button type="button" onclick="toggleTheme()">Toggle Theme</button>
    </div>
  </div>

  <form id="leadForm" aria-label="Add New Lead Form">
    <input type="text" name="firstName" placeholder="First Name" required autocomplete="given-name" />
    <input type="text" name="lastName" placeholder="Last Name" required autocomplete="family-name" />
    <input type="tel" name="phone" placeholder="Phone" required autocomplete="tel" />
    <input type="email" name="email" placeholder="Email" required autocomplete="email" />
    <input type="text" name="tortType" placeholder="Tort Type" required />
    <button type="submit">Add Lead</button>
  </form>

  <table id="leadsTable" aria-label="Leads Table">
    <thead>
      <tr id="tableHeaderRow">
        <th draggable="true" data-field="firstName" scope="col">First Name</th>
        <th draggable="true" data-field="lastName" scope="col">Last Name</th>
        <th draggable="true" data-field="phone" scope="col">Phone</th>
        <th draggable="true" data-field="email" scope="col">Email</th>
        <th draggable="true" data-field="tortType" scope="col">Tort</th>
        <th draggable="true" data-field="status" scope="col">Status</th>
        <th draggable="true" data-field="createdAt" scope="col">Date</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody id="leadsBody"></tbody>
  </table>

  <script>
    const apiUrl = "https://crm-backend2-fhi5.onrender.com";

    const settingsIcon = document.getElementById("settingsIcon");
    const settingsPanel = document.getElementById("settingsPanel");

    settingsIcon.onclick = () => {
      settingsPanel.style.display = settingsPanel.style.display === "block" ? "none" : "block";
    };

    // Toggle column visibility
    document.querySelectorAll(".column-toggle").forEach(toggle => {
      toggle.addEventListener("change", () => {
        const field = toggle.value;
        const visible = toggle.checked;
        // Show/hide header
        document.querySelectorAll(`th[data-field="${field}"]`).forEach(th => {
          th.style.display = visible ? "" : "none";
        });
        // Show/hide corresponding cells
        document.querySelectorAll(`td[data-field="${field}"]`).forEach(td => {
          td.style.display = visible ? "" : "none";
        });
      });
    });

    // Toggle theme
    function toggleTheme() {
      document.body.classList.toggle("dark");
    }

    // Add new lead
    document.getElementById("leadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const lead = {
        firstName: form.firstName.value.trim(),
        lastName: form.lastName.value.trim(),
        phone: form.phone.value.trim(),
        email: form.email.value.trim(),
        tortType: form.tortType.value.trim(),
        status: "new"
      };

      try {
        const res = await fetch(`${apiUrl}/leads`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(lead)
        });
        const data = await res.json();
        if (res.ok) {
          alert("Lead created successfully!");
          form.reset();
          loadLeads();
        } else {
          alert("Failed to create lead: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        alert("Error submitting lead.");
        console.error(err);
      }
    });

    // Load leads from backend and render
    async function loadLeads() {
      try {
        const res = await fetch(`${apiUrl}/leads`);
        if (!res.ok) throw new Error("Failed to fetch leads");
        const leads = await res.json();
        const tbody = document.getElementById("leadsBody");
        tbody.innerHTML = "";

        leads.forEach(lead => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td data-field="firstName" contenteditable="true">${escapeHtml(lead.firstName)}</td>
            <td data-field="lastName" contenteditable="true">${escapeHtml(lead.lastName)}</td>
            <td data-field="phone" contenteditable="true">${escapeHtml(lead.phone)}</td>
            <td data-field="email" contenteditable="true">${escapeHtml(lead.email)}</td>
            <td data-field="tortType" contenteditable="true">${escapeHtml(lead.tortType)}</td>
            <td data-field="status" contenteditable="true">${escapeHtml(capitalize(lead.status))}</td>
            <td data-field="createdAt">${new Date(lead.createdAt).toLocaleDateString()}</td>
            <td class="actions">
              <button onclick="saveLead('${lead._id}', this)">Save</button>
            </td>
          `;
          tbody.appendChild(row);
        });

        // Apply current column visibility settings
        document.querySelectorAll(".column-toggle").forEach(toggle => {
          const field = toggle.value;
          const visible = toggle.checked;
          document.querySelectorAll(`th[data-field="${field}"]`).forEach(th => {
            th.style.display = visible ? "" : "none";
          });
          document.querySelectorAll(`td[data-field="${field}"]`).forEach(td => {
            td.style.display = visible ? "" : "none";
          });
        });

      } catch (err) {
        console.error(err);
        alert("Failed to load leads.");
      }
    }

    // Save edited lead
    async function saveLead(id, btn) {
      const row = btn.closest("tr");
      const updatedLead = {
        firstName: row.children[0].textContent.trim(),
        lastName: row.children[1].textContent.trim(),
        phone: row.children[2].textContent.trim(),
        email: row.children[3].textContent.trim(),
        tortType: row.children[4].textContent.trim(),
        status: row.children[5].textContent.trim().toLowerCase(),
      };

      try {
        const res = await fetch(`${apiUrl}/leads/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedLead)
        });
        if (res.ok) {
          alert("Lead updated successfully!");
          loadLeads();
        } else {
          alert("Failed to update lead.");
        }
      } catch (err) {
        alert("Error updating lead.");
        console.error(err);
      }
    }

    // Sort leads when clicking headers
    document.querySelectorAll("th[data-field]").forEach(th => {
      let asc = true;
      th.addEventListener("click", () => {
        const field = th.dataset.field;
        sortLeads(field, asc);
        asc = !asc;
      });
    });

    function sortLeads(field, asc) {
      const tbody = document.getElementById("leadsBody");
      const rows = Array.from(tbody.rows);
      rows.sort((a, b) => {
        const valA = a.querySelector(`[data-field="${field}"]`)?.textContent.trim().toLowerCase() || "";
        const valB = b.querySelector(`[data-field="${field}"]`)?.textContent.trim().toLowerCase() || "";
        if (field === "createdAt") {
          return asc ? new Date(valA) - new Date(valB) : new Date(valB) - new Date(valA);
        }
        return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
      });
      rows.forEach(row => tbody.appendChild(row));
    }

    // Drag and drop for column reordering (headers + all rows)
    const headerRow = document.getElementById("tableHeaderRow");
    let draggedColIndex = null;

    headerRow.querySelectorAll("th[draggable='true']").forEach(th => {
      th.addEventListener("dragstart", e => {
        draggedColIndex = e.target.cellIndex;
        e.dataTransfer.effectAllowed = "move";
      });

      th.addEventListener("dragover", e => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      th.addEventListener("drop", e => {
        e.preventDefault();
        const targetColIndex = e.target.cellIndex;
        if (draggedColIndex === null || targetColIndex === draggedColIndex) return;

        // Move header cell
        if (draggedColIndex < targetColIndex) {
          headerRow.insertBefore(headerRow.cells[draggedColIndex], headerRow.cells[targetColIndex].nextSibling);
        } else {
          headerRow.insertBefore(headerRow.cells[draggedColIndex], headerRow.cells[targetColIndex]);
        }

        // Move all cells in each row accordingly
        const tbody = document.getElementById("leadsBody");
        Array.from(tbody.rows).forEach(row => {
          if (draggedColIndex < targetColIndex) {
            row.insertBefore(row.cells[draggedColIndex], row.cells[targetColIndex].nextSibling);
          } else {
            row.insertBefore(row.cells[draggedColIndex], row.cells[targetColIndex]);
          }
        });

        draggedColIndex = null;
      });
    });

    // Helper to escape HTML
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Capitalize first letter helper
    function capitalize(s) {
      return s && s.length > 0 ? s.charAt(0).toUpperCase() + s.slice(1) : s;
    }

    loadLeads();
  </script>
</body>
</html>
